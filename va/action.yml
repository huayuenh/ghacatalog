name: Vulnerabiity Advisor
description: Check Vulnerability Advisor scan

runs:
  using: composite
  steps:
    - name: Vulnerability Advisor
      id: va
      shell: bash
      run: |
        ibmcloud login --apikey "${IBMCLOUD_API_KEY}" -r "${IBMCLOUD_REGION}" -g "${RESOURCE_GROUP}"
        ibmcloud cr region-set "${IBMCLOUD_REGION}"
        ibmcloud cr login

        IMAGE_URL="$REGISTRY_HOSTNAME"/"$ICR_NAMESPACE"/"$IMAGE_NAME":"$GITHUB_SHA"
        echo -e "Details for image: ${IMAGE_URL}"
        ibmcloud cr image-inspect ${IMAGE_URL}

        echo -e "Checking vulnerabilities in image: ${IMAGE_URL}"
        for ITER in {1..20}
        do
          set +e
          STATUS=""
          ibmcloud cr va -o json ${IMAGE_URL} > vareport.json
          # ibmcloud cr va returns a non valid json output if image not yet scanned
          if jq -r -e '.[0].status' vareport.json > /dev/null 2>&1; then
            STATUS=$( jq -r '.[0].status' vareport.json)
          fi
          if [ -z "$STATUS" ]; then
            STATUS="UNSCANNED"
            cat vareport.json
          fi
          set -e
          echo "VA scan status is ${STATUS}"
          # Possible status from Vulnerability Advisor: OK, WARN, FAIL, UNSUPPORTED, INCOMPLETE, UNSCANNED
          # cf https://cloud.ibm.com/apidocs/container-registry/va#get-the-vulnerability-assessment-for-the-list-of-r
          if [[ "${STATUS}" != "INCOMPLETE" && "${STATUS}" != "UNSCANNED" ]]; then
            # status is one of the terminated scan action - break the loop
            break
          fi
          echo -e "${ITER} STATUS ${STATUS} : A vulnerability report was not found for the specified image."
          echo "Either the image doesn't exist or the scan hasn't completed yet. "
          echo "Waiting 10s for scan to complete..."
          sleep 10
        done
        set +
        echo "Showing extended vulnerability assessment report for ${IMAGE_URL}"

        ibmcloud cr va -e ${IMAGE_URL} || true
        if [[ "${STATUS}" == "OK" ]] || [[ "${STATUS}" == "UNSUPPORTED" ]] || [[ "${STATUS}" == "WARN" ]]; then
            echo "The vulnerability scan status is ${STATUS}"
        else
          echo -n "ERROR: The vulnerability scan was not successful (status being ${STATUS}), "
          echo "check the OUTPUT of the command and try again."
          exit 1;
        fi